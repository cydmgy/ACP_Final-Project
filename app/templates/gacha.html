{% extends "base.html" %}

{% block content %}
<div class="gacha-container">

    <div class="gacha-header">
        <h2>Gacha Section</h2>
        <div class="coins-display">
            <h3>Your Coins: <span id="gacha-coins">{{ coins }}</span></h3>
        </div>
    </div>

    <!-- Pity Counter Display -->
    <div class="pity-display">
        <div class="pity-item">
            <span class="pity-label">Epic Pity:</span>
            <span class="pity-value" id="pity-counter">{{ pity_counter }}/10</span>
        </div>
        <div class="pity-item">
            <span class="pity-label">Legendary Pity:</span>
            <span class="pity-value" id="legendary-pity">{{ legendary_pity }}/80</span>
        </div>
    </div>

    <div class="gacha-middle-row">
        <div class="gacha-result-center">
            <div id="gacha-result"></div>
        </div>
        <div class="gacha-info">
            <p>1x Pull: 5 coins</p>
            <p>10x Pull: 50 coins</p>
            <p style="font-size: 14px; color: #4fc3f7; margin-top: 10px;">
                ðŸ’Ž Guaranteed epic every 10 pulls<br>
                ðŸ‘‘ Guaranteed legendary every 80 pulls
            </p>
        </div>
    </div>

    <div class="gacha-pull">
        <button id="pull-single" class="gacha-button">1x Pull</button>
        <button id="pull-multi" class="gacha-button">10x Pull</button>
        <div id="gacha-result"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const STATIC_BASE_URL = "{{ url_for('static', filename='') }}";

    function createCreatureCard(creature, isMini = false) {
        const imageUrl = STATIC_BASE_URL + creature.image;
        const pityBadge = creature.pity ? '<span class="pity-badge">âœ¨ PITY!</span>' : '';
        
        let cardHtml = `
            <div class="creature-card ${creature.rarity} ${isMini ? 'mini' : ''}">
                ${pityBadge}
                <div class="creature-image-gacha">
                    <img src="${imageUrl}" alt="${creature.name}">
                </div>
                <h4>${creature.name}</h4>
                <p class="rarity-text">${creature.rarity}</p>
            </div>
        `;
        
        return cardHtml;
    }

    function updatePityDisplay(pityCounter, legendaryPity) {
        $('#pity-counter').text(pityCounter + '/10');
        $('#legendary-pity').text(legendaryPity + '/80');
    }

    $(document).ready(function() {
        console.log("Gacha page loaded");
        
        $('#pull-single').click(function() {
            console.log("Single pull clicked");
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'single'}),
                success: function(data) {
                    console.log("Single pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        updatePityDisplay(data.pity_counter, data.legendary_pity);
                        
                        const creature = data.creature;
                        
                        const cardHtml = `
                            <div class="gacha-result-card">
                                <h3>You got a ${creature.name}!</h3>
                                ${createCreatureCard(creature)}
                                <p>Added to your inventory!</p>
                            </div>
                        `;
                        $('#gacha-result').html(`
                            <div class="single-pull-result">
                                ${cardHtml}
                            </div>
                        `);

                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Single pull error:", error);
                    $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                }
            });
        });

        $('#pull-multi').click(function() {
            console.log("Multi pull clicked");
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'multi'}),
                success: function(data) {
                    console.log("Multi pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        updatePityDisplay(data.pity_counter, data.legendary_pity);
                        
                        let resultHtml = '<div class="multi-result"><h3>10x Pull Results:</h3><div class="creatures-grid">';
                        
                        data.creatures.forEach(creature => {
                            resultHtml += createCreatureCard(creature, true); 
                        });
                        
                        resultHtml += '</div></div>';
                       $('#gacha-result').html(`
                            <div class="multi-pull-result">
                                ${resultHtml}
                            </div>
                        `);
                        
                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Multi pull error:", error);
                    $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                }
            });
        });
    });
</script>
{% endblock %}