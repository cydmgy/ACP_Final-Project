{% extends "base.html" %}

{% block content %}
<div class="gacha-container">

    <div class="gacha-header">
        <h2>Gacha Section</h2>
        <div class="coins-display">
            <h3>Your Coins: <span id="gacha-coins">{{ coins }}</span></h3>
        </div>
    </div>

    <!-- Pity Counter Display -->
    <div class="pity-display">
        <div class="pity-item">
            <span class="pity-label">Epic Pity:</span>
            <span class="pity-value" id="pity-counter">{{ pity_counter }}/10</span>
        </div>
        <div class="pity-item">
            <span class="pity-label">Legendary Pity:</span>
            <span class="pity-value" id="legendary-pity">{{ legendary_pity }}/80</span>
        </div>
    </div>

    <div class="gacha-middle-row">
        <div class="gacha-result-center">
            <div id="gacha-result"></div>
        </div>
        <div class="gacha-info">
            <p>1x Pull: 5 coins</p>
            <p>10x Pull: 50 coins</p>
            <p style="font-size: 14px; color: #4fc3f7; margin-top: 10px;">
                ðŸ’Ž Guaranteed epic every 10 pulls<br>
                ðŸ‘‘ Guaranteed legendary every 80 pulls
            </p>
        </div>
    </div>

    <div class="gacha-pull">
        <button id="pull-single" class="gacha-button">1x Pull</button>
        <button id="pull-multi" class="gacha-button">10x Pull</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const STATIC_BASE_URL = "{{ url_for('static', filename='') }}";

    function createFlipCard(creature, isMini = false, delay = 0) {
        const imageUrl = STATIC_BASE_URL + creature.image;
        const pityBadge = creature.pity ? '<span class="pity-badge">âœ¨ PITY!</span>' : '';
        
        let cardHtml = `
            <div class="flip-card-container ${isMini ? 'mini' : ''}" style="animation-delay: ${delay}ms;">
                <div class="flip-card">
                    <div class="flip-card-inner">
                        <!-- Back of card (shown initially) -->
                        <div class="flip-card-back">
                            <div class="card-back-design">
                                <div class="card-back-pattern"></div>
                                <div class="card-back-shine"></div>
                                <div class="card-back-text">?</div>
                            </div>
                        </div>
                        <!-- Front of card (revealed after flip) -->
                        <div class="flip-card-front">
                            <div class="creature-card ${creature.rarity} ${isMini ? 'mini' : ''}">
                                ${pityBadge}
                                <div class="creature-image-gacha">
                                    <img src="${imageUrl}" alt="${creature.name}">
                                </div>
                                <h4>${creature.name}</h4>
                                <p class="rarity-text">${creature.rarity}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        return cardHtml;
    }

    function updatePityDisplay(pityCounter, legendaryPity) {
        $('#pity-counter').text(pityCounter + '/10');
        $('#legendary-pity').text(legendaryPity + '/80');
    }

    $(document).ready(function() {
        console.log("Gacha page loaded");
        
        // Single Pull Handler
        $('#pull-single').click(function() {
            console.log("Single pull clicked");
            
            // Disable button during animation
            $(this).prop('disabled', true);
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'single'}),
                success: function(data) {
                    console.log("Single pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        updatePityDisplay(data.pity_counter, data.legendary_pity);
                        
                        const creature = data.creature;
                        const flipCardHtml = createFlipCard(creature, false, 0);
                        
                        // Show only the card, no text
                        $('#gacha-result').html(`
                            <div class="single-pull-result">
                                ${flipCardHtml}
                            </div>
                        `);

                        // Trigger flip animation after a short delay
                        setTimeout(() => {
                            $('.flip-card-container').addClass('flipped');
                        }, 500);

                        // Re-enable button after animation
                        setTimeout(() => {
                            $('#pull-single').prop('disabled', false);
                        }, 2000);

                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                        $('#pull-single').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Single pull error:", error);
                    $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                    $('#pull-single').prop('disabled', false);
                }
            });
        });

        // Multi Pull Handler (10x)
        $('#pull-multi').click(function() {
            console.log("Multi pull clicked");
            
            // Disable button during animation
            $(this).prop('disabled', true);
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'multi'}),
                success: function(data) {
                    console.log("Multi pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        updatePityDisplay(data.pity_counter, data.legendary_pity);
                        
                        // Create grid with all cards (back side showing)
                        let resultHtml = '<div class="multi-result"><div class="creatures-grid">';
                        
                        data.creatures.forEach((creature, index) => {
                            const delay = index * 500;
                            resultHtml += createFlipCard(creature, true, delay);
                        });
                        
                        resultHtml += '</div></div>';
                        
                        $('#gacha-result').html(resultHtml);

                        // Start flipping cards one by one
                        setTimeout(() => {
                            $('.flip-card-container').each(function(index) {
                                const $card = $(this);
                                setTimeout(() => {
                                    $card.addClass('flipped');
                                }, index * 500);
                            });
                        }, 500);

                        // Re-enable button after all animations complete
                        setTimeout(() => {
                            $('#pull-multi').prop('disabled', false);
                        }, 6000);

                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                        $('#pull-multi').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Multi pull error:", error);
                    $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                    $('#pull-multi').prop('disabled', false);
                }
            });
        });
    });
</script>
{% endblock %}