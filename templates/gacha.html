<!-- ============================================ -->
<!-- UPDATED gacha.html -->
<!-- ============================================ -->

{% extends "base.html" %}

{% block content %}
<div class="gacha-container">

    <div class="gacha-header">
        <h2>Gacha Section</h2>
        <div class="coins-display">
            <h3>Your Coins: <span id="gacha-coins">{{ coins }}</span></h3>
        </div>
    </div>
    
    <div class="gacha-middle-row">
        <div class="gacha-result-center">
            <!-- This is where the spinning animation will appear -->
            <div id="gacha-result">
                <div class="ready-state">
                    <p>ðŸŒŠ Ready to pull? ðŸŒŠ</p>
                </div>
            </div>
        </div>
        <div class="gacha-info">
            <p>1x Pull: 5 coins</p>
            <p>10x Pull: 50 coins</p>
        </div>
    </div>

    <div class="gacha-pull">
        <button id="pull-single" class="gacha-button">1x Pull</button>
        <button id="pull-multi" class="gacha-button">10x Pull</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const STATIC_BASE_URL = "{{ url_for('static', filename='') }}";

    // Helper function to create the HTML string for a creature card with an image
    function createCreatureCard(creature, isMini = false) {
        const imageUrl = STATIC_BASE_URL + creature.image;
        
        let cardHtml = `
            <div class="creature-card ${creature.rarity} ${isMini ? 'mini' : ''}">
                <div class="creature-image-gacha">
                    <img src="${imageUrl}" alt="${creature.name}">
                </div>
                <h4>${creature.name}</h4>
                <p class="rarity-text">${creature.rarity}</p>
            </div>
        `;
        
        return cardHtml;
    }

    // Show spinning animation
    function showSpinning() {
        $('#gacha-result').html(`
            <div class="spinning-container">
                <div class="spinner">ðŸŒŠ</div>
                <p class="rolling-text">Rolling...</p>
            </div>
        `);
    }

    // Show single pull result with reveal animation
    function showSingleResult(creature, coins) {
        const cardHtml = `
            <div class="gacha-result-card reveal-animation">
                <h3>You got a ${creature.name}!</h3>
                ${createCreatureCard(creature)}
                <p>Added to your inventory!</p>
            </div>
        `;
        $('#gacha-result').html(cardHtml);
        $('#gacha-coins').text(coins);
    }

    // Show multi pull results
    function showMultiResult(creatures, coins) {
        let resultHtml = `
            <div class="multi-result reveal-animation">
                <h3>10x Pull Results:</h3>
                <div class="creatures-grid">
        `;
        
        creatures.forEach(creature => {
            resultHtml += createCreatureCard(creature, true); 
        });
        
        resultHtml += '</div></div>';
        $('#gacha-result').html(resultHtml);
        $('#gacha-coins').text(coins);
    }

    $(document).ready(function() {
        console.log("Gacha page loaded");
        
        // --- Single Pull Logic ---
        $('#pull-single').click(function() {
            console.log("Single pull clicked");
            
            // Show spinning animation immediately
            showSpinning();
            
            // Disable buttons during pull
            $('#pull-single, #pull-multi').prop('disabled', true);
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'single'}),
                success: function(data) {
                    console.log("Single pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        
                        const creature = data.creature;
                        
                        // Use the helper function to build the card HTML with the image
                        const cardHtml = `
                            <div class="gacha-result-card">
                                <h3>You got a ${creature.name}!</h3>
                                ${createCreatureCard(creature)}
                                <p>Added to your inventory!</p>
                            </div>
                        `;
                        $('#gacha-result').html(`
                            <div class="single-pull-result">
                                ${cardHtml}
                            </div>
                        `);

                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Single pull error:", error);
                    setTimeout(() => {
                        $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                        $('#pull-single, #pull-multi').prop('disabled', false);
                    }, 2000);
                }
            });
        });

        // --- Multi Pull Logic ---
        $('#pull-multi').click(function() {
            console.log("Multi pull clicked");
            
            // Show spinning animation
            showSpinning();
            
            // Disable buttons during pull
            $('#pull-single, #pull-multi').prop('disabled', true);
            
            $.ajax({
                url: '/pull_gacha',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({type: 'multi'}),
                success: function(data) {
                    console.log("Multi pull success:", data);
                    if (data.success) {
                        $('#gacha-coins').text(data.coins);
                        
                        let resultHtml = '<div class="multi-result"><h3>10x Pull Results:</h3><div class="creatures-grid">';
                        
                        data.creatures.forEach(creature => {
                            // Use the helper function to build mini-cards with images
                            resultHtml += createCreatureCard(creature, true); 
                        });
                        
                        resultHtml += '</div></div>';
                       $('#gacha-result').html(`
                            <div class="multi-pull-result">
                                ${resultHtml}
                            </div>
                        `);
                        
                    } else {
                        $('#gacha-result').html(`<div class="error-message">${data.message}</div>`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Multi pull error:", error);
                    setTimeout(() => {
                        $('#gacha-result').html(`<div class="error-message">Error: ${error}</div>`);
                        $('#pull-single, #pull-multi').prop('disabled', false);
                    }, 2000);
                }
            });
        });
    });
</script>
{% endblock %}