{% extends "base.html" %}

{% block content %}
<div class="home-container">
    <div class="stats-header">
        <div class="stat-card">
            <h3>Player</h3>
            <div class="stat-value" style="font-size: 1.2rem;">{{ username }}</div>
            <a href="{{ url_for('logout') }}" style="font-size: 0.8rem; color: #ff6b6b;">Log Out</a>
        </div>
        <div class="stat-card">
            <h3>Total Clicks</h3>
            <div class="stat-value" id="click-counter">{{ clicks }}</div>
        </div>
        <div class="stat-card">
            <h3>Coins</h3>
            <div class="stat-value" id="coin-counter">{{ coins }}</div>
        </div>
        <div class="stat-card" id="pulls-stat-card">
            <h3>Available Pulls</h3>
            <div class="stat-value" id="pull-counter">{{ coins // 20 }}</div>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

    <div class="click-area">
        <h2>Click to Earn Coins!</h2>
        <button id="click-button" class="ocean-button">Click here</button>
        <p>Every 5 clicks gives 1 coin!</p>
    </div>

    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

    <div class="missions-panel">
        <h2>Missions</h2>
        <div class="missions-list">
            {% for mission in missions %}
            <div class="mission-item {% if mission.id in completed_missions %}completed{% endif %}">
                <div class="mission-info">
                    <h4>{{ mission.name }}</h4>
                    <p>{{ mission.description }}</p>
                </div>
                <div class="mission-reward">
                    <span class="reward-amount">+{{ mission.reward }} coins</span>
                    {% if mission.mission_id in completed_missions %}
                    <span class="completed-badge">âœ“ Completed</span>
                    {% else %}
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ (clicks / mission.target * 100) if mission.target > 0 else 0 }}%"></div>
                        <span class="progress-text">{{ clicks }}/{{ mission.target }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log("Document ready - click script loaded");
    
    $('#click-button').click(function() {
        $.post('/click', function(data) {
            // Update Clicks and Coins
            $('#click-counter').text(data.clicks);
            $('#coin-counter').text(data.coins);
            $('#pull-counter').text(Math.floor(data.coins / 20));

            // Handle Mission Completion
            if (data.coins_earned > 0) {
                alert('Mission Complete! +' + data.coins_earned + ' coins!');
                location.reload(); 
            }
        }).fail(function(xhr, status, error) {
            // If session expired (401 Unauthorized), redirect to auth
            if (xhr.status === 401) {
                window.location.href = "{{ url_for('auth') }}";
            } else {
                console.error("Error:", error);
            }
        });
    });
});
</script>
{% endblock %}